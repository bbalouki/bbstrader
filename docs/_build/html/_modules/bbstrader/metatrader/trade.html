

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>bbstrader.metatrader.trade &mdash; bbstrader 0.2.092 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=97badf68"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            bbstrader
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">bbstrader</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">bbstrader</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">bbstrader.metatrader.trade</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for bbstrader.metatrader.trade</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">Logger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">quantstats</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">qs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">loguru</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span> <span class="k">as</span> <span class="n">log</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tabulate</span><span class="w"> </span><span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">bbstrader.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">BBSTRADER_DIR</span><span class="p">,</span> <span class="n">config_logger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bbstrader.metatrader.account</span><span class="w"> </span><span class="kn">import</span> <span class="n">INIT_MSG</span><span class="p">,</span> <span class="n">check_mt5_connection</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bbstrader.metatrader.risk</span><span class="w"> </span><span class="kn">import</span> <span class="n">RiskManagement</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bbstrader.metatrader.utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">TradeDeal</span><span class="p">,</span>
    <span class="n">TradePosition</span><span class="p">,</span>
    <span class="n">raise_mt5_error</span><span class="p">,</span>
    <span class="n">trade_retcode_message</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">MetaTrader5</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">Mt5</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">bbstrader.compat</span>  <span class="c1"># noqa: F401</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Trade&quot;</span><span class="p">,</span>
    <span class="s2">&quot;create_trade_instance&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">log</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BBSTRADER_DIR</span><span class="si">}</span><span class="s2">/logs/trade.log&quot;</span><span class="p">,</span>
    <span class="n">enqueue</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;{time:YYYY-MM-DD HH:mm:ss} | </span><span class="si">{level}</span><span class="s2"> | </span><span class="si">{name}</span><span class="s2"> | </span><span class="si">{message}</span><span class="s2">&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">global</span> <span class="n">LOGGER</span>
<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">log</span>


<span class="n">FILLING_TYPE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_FILLING_IOC</span><span class="p">,</span>
    <span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_FILLING_RETURN</span><span class="p">,</span>
    <span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_FILLING_BOC</span><span class="p">,</span>
<span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TradeAction</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An enumeration class for trade actions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">BUY</span> <span class="o">=</span> <span class="s2">&quot;LONG&quot;</span>
    <span class="n">SELL</span> <span class="o">=</span> <span class="s2">&quot;SHORT&quot;</span>
    <span class="n">LONG</span> <span class="o">=</span> <span class="s2">&quot;LONG&quot;</span>
    <span class="n">SHORT</span> <span class="o">=</span> <span class="s2">&quot;SHORT&quot;</span>
    <span class="n">BMKT</span> <span class="o">=</span> <span class="s2">&quot;BMKT&quot;</span>
    <span class="n">SMKT</span> <span class="o">=</span> <span class="s2">&quot;SMKT&quot;</span>
    <span class="n">BLMT</span> <span class="o">=</span> <span class="s2">&quot;BLMT&quot;</span>
    <span class="n">SLMT</span> <span class="o">=</span> <span class="s2">&quot;SLMT&quot;</span>
    <span class="n">BSTP</span> <span class="o">=</span> <span class="s2">&quot;BSTP&quot;</span>
    <span class="n">SSTP</span> <span class="o">=</span> <span class="s2">&quot;SSTP&quot;</span>
    <span class="n">BSTPLMT</span> <span class="o">=</span> <span class="s2">&quot;BSTPLMT&quot;</span>
    <span class="n">SSTPLMT</span> <span class="o">=</span> <span class="s2">&quot;SSTPLMT&quot;</span>
    <span class="n">EXIT</span> <span class="o">=</span> <span class="s2">&quot;EXIT&quot;</span>
    <span class="n">EXIT_LONG</span> <span class="o">=</span> <span class="s2">&quot;EXIT_LONG&quot;</span>
    <span class="n">EXIT_SHORT</span> <span class="o">=</span> <span class="s2">&quot;EXIT_SHORT&quot;</span>
    <span class="n">EXIT_STOP</span> <span class="o">=</span> <span class="s2">&quot;EXIT_STOP&quot;</span>
    <span class="n">EXIT_LIMIT</span> <span class="o">=</span> <span class="s2">&quot;EXIT_LIMIT&quot;</span>
    <span class="n">EXIT_LONG_STOP</span> <span class="o">=</span> <span class="s2">&quot;EXIT_LONG_STOP&quot;</span>
    <span class="n">EXIT_LONG_LIMIT</span> <span class="o">=</span> <span class="s2">&quot;EXIT_LONG_LIMIT&quot;</span>
    <span class="n">EXIT_SHORT_STOP</span> <span class="o">=</span> <span class="s2">&quot;EXIT_SHORT_STOP&quot;</span>
    <span class="n">EXIT_SHORT_LIMIT</span> <span class="o">=</span> <span class="s2">&quot;EXIT_SHORT_LIMIT&quot;</span>
    <span class="n">EXIT_LONG_STOP_LIMIT</span> <span class="o">=</span> <span class="s2">&quot;EXIT_LONG_STOP_LIMIT&quot;</span>
    <span class="n">EXIT_SHORT_STOP_LIMIT</span> <span class="o">=</span> <span class="s2">&quot;EXIT_SHORT_STOP_LIMIT&quot;</span>
    <span class="n">EXIT_PROFITABLES</span> <span class="o">=</span> <span class="s2">&quot;EXIT_PROFITABLES&quot;</span>
    <span class="n">EXIT_LOSINGS</span> <span class="o">=</span> <span class="s2">&quot;EXIT_LOSINGS&quot;</span>
    <span class="n">EXIT_ALL_POSITIONS</span> <span class="o">=</span> <span class="s2">&quot;EXIT_ALL_POSITIONS&quot;</span>
    <span class="n">EXIT_ALL_ORDERS</span> <span class="o">=</span> <span class="s2">&quot;EXIT_ALL_ORDERS&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>


<span class="nd">@dataclass</span><span class="p">()</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TradeSignal</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a trading signal generated by a trading system or strategy.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        id (int):</span>
<span class="sd">            A unique identifier for the trade signal or the strategy.</span>

<span class="sd">        symbol (str):</span>
<span class="sd">            The trading symbol (e.g., stock ticker, forex pair, crypto asset)</span>
<span class="sd">            related to the signal.</span>

<span class="sd">        action (TradeAction):</span>
<span class="sd">            The trading action to perform.</span>
<span class="sd">            Must be an instance of the `TradeAction` enum (e.g., BUY, SELL).</span>

<span class="sd">        price (float, optional):</span>
<span class="sd">            The price at which the trade should be executed.</span>

<span class="sd">        stoplimit (float, optional):</span>
<span class="sd">            A stop-limit price for the trade.</span>
<span class="sd">            Must not be set without specifying a price.</span>

<span class="sd">        comment (str, optional):</span>
<span class="sd">            An optional comment or description related to the trade signal.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">action</span><span class="p">:</span> <span class="n">TradeAction</span>
    <span class="n">price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">stoplimit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="n">TradeAction</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;action must be of type TradeAction, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stoplimit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">price</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;stoplimit cannot be set without price&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;TradeSignal(id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">, symbol=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&#39;, action=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;price=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">price</span><span class="si">}</span><span class="s2">, stoplimit=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stoplimit</span><span class="si">}</span><span class="s2">), comment=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">comment</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TradingMode</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">BACKTEST</span> <span class="o">=</span> <span class="s2">&quot;BACKTEST&quot;</span>
    <span class="n">LIVE</span> <span class="o">=</span> <span class="s2">&quot;LIVE&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">isbacktest</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="o">==</span> <span class="n">TradingMode</span><span class="o">.</span><span class="n">BACKTEST</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">islive</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="o">==</span> <span class="n">TradingMode</span><span class="o">.</span><span class="n">LIVE</span>


<span class="n">Buys</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;BMKT&quot;</span><span class="p">,</span> <span class="s2">&quot;BLMT&quot;</span><span class="p">,</span> <span class="s2">&quot;BSTP&quot;</span><span class="p">,</span> <span class="s2">&quot;BSTPLMT&quot;</span><span class="p">]</span>
<span class="n">Sells</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;SMKT&quot;</span><span class="p">,</span> <span class="s2">&quot;SLMT&quot;</span><span class="p">,</span> <span class="s2">&quot;SSTP&quot;</span><span class="p">,</span> <span class="s2">&quot;SSTPLMT&quot;</span><span class="p">]</span>
<span class="n">Positions</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;buy&quot;</span><span class="p">,</span> <span class="s2">&quot;sell&quot;</span><span class="p">,</span> <span class="s2">&quot;profitable&quot;</span><span class="p">,</span> <span class="s2">&quot;losing&quot;</span><span class="p">]</span>
<span class="n">Orders</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span>
    <span class="s2">&quot;all&quot;</span><span class="p">,</span>
    <span class="s2">&quot;buy_stops&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sell_stops&quot;</span><span class="p">,</span>
    <span class="s2">&quot;buy_limits&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sell_limits&quot;</span><span class="p">,</span>
    <span class="s2">&quot;buy_stop_limits&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sell_stop_limits&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">EXPERT_ID</span> <span class="o">=</span> <span class="mi">98181105</span>


<div class="viewcode-block" id="Trade">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Trade</span><span class="p">(</span><span class="n">RiskManagement</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extends the `RiskManagement` class to include specific trading operations,</span>
<span class="sd">    incorporating risk management strategies directly into trade executions.</span>
<span class="sd">    It offers functionalities to execute trades while managing risks</span>
<span class="sd">    according to the inherited RiskManagement parameters and methods.</span>

<span class="sd">    Exemple:</span>
<span class="sd">        &gt;&gt;&gt; import time</span>
<span class="sd">        &gt;&gt;&gt; # Initialize the Trade class with parameters</span>
<span class="sd">        &gt;&gt;&gt; trade = Trade(</span>
<span class="sd">        ...     symbol=&quot;EURUSD&quot;,              # Symbol to trade</span>
<span class="sd">        ...     expert_name=&quot;bbstrader&quot;,      # Name of the expert advisor</span>
<span class="sd">        ...     expert_id=12345,              # Unique ID for the expert advisor</span>
<span class="sd">        ...     version=&quot;1.0&quot;,                # Version of the expert advisor</span>
<span class="sd">        ...     target=5.0,                   # Daily profit target in percentage</span>
<span class="sd">        ...     start_time=&quot;09:00&quot;,           # Start time for trading</span>
<span class="sd">        ...     finishing_time=&quot;17:00&quot;,       # Time to stop opening new positions</span>
<span class="sd">        ...     ending_time=&quot;17:30&quot;,          # Time to close any open positions</span>
<span class="sd">        ...     max_risk=2.0,                 # Maximum risk allowed on the account in percentage</span>
<span class="sd">        ...     daily_risk=1.0,               # Daily risk allowed in percentage</span>
<span class="sd">        ...     max_trades=5,                 # Maximum number of trades per session</span>
<span class="sd">        ...     rr=2.0,                       # Risk-reward ratio</span>
<span class="sd">        ...     account_leverage=True,        # Use account leverage in calculations</span>
<span class="sd">        ...     std_stop=True,                # Use standard deviation for stop loss calculation</span>
<span class="sd">        ...     sl=20,                        # Stop loss in points (optional)</span>
<span class="sd">        ...     tp=30,                        # Take profit in points (optional)</span>
<span class="sd">        ...     be=10                         # Break-even in points (optional)</span>
<span class="sd">        ... )</span>

<span class="sd">        &gt;&gt;&gt; # Example to open a buy position</span>
<span class="sd">        &gt;&gt;&gt; trade.open_buy_position(mm=True, comment=&quot;Opening Buy Position&quot;)</span>

<span class="sd">        &gt;&gt;&gt; # Example to open a sell position</span>
<span class="sd">        &gt;&gt;&gt; trade.open_sell_position(mm=True, comment=&quot;Opening Sell Position&quot;)</span>

<span class="sd">        &gt;&gt;&gt; # Check current open positions</span>
<span class="sd">        &gt;&gt;&gt; opened_positions = trade.get_opened_positions</span>
<span class="sd">        &gt;&gt;&gt; if opened_positions is not None:</span>
<span class="sd">        ...     print(f&quot;Current open positions: {opened_positions}&quot;)</span>

<span class="sd">        &gt;&gt;&gt; # Close all open positions at the end of the trading session</span>
<span class="sd">        &gt;&gt;&gt; if trade.days_end():</span>
<span class="sd">        ...    trade.close_all_positions(comment=&quot;Closing all positions at day&#39;s end&quot;)</span>

<span class="sd">        &gt;&gt;&gt; # Print trading session statistics</span>
<span class="sd">        &gt;&gt;&gt; trade.statistics(save=True, dir=&quot;my_trading_stats&quot;)</span>

<span class="sd">        &gt;&gt;&gt; # Sleep until the next trading session if needed (example usage)</span>
<span class="sd">        &gt;&gt;&gt; sleep_time = trade.sleep_time()</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Sleeping for {sleep_time} minutes until the next trading session.&quot;)</span>
<span class="sd">        &gt;&gt;&gt; time.sleep(sleep_time * 60)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;EURUSD&quot;</span><span class="p">,</span>
        <span class="n">expert_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bbstrader&quot;</span><span class="p">,</span>
        <span class="n">expert_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">EXPERT_ID</span><span class="p">,</span>
        <span class="n">version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="n">start_time</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;0:00&quot;</span><span class="p">,</span>
        <span class="n">finishing_time</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;23:59&quot;</span><span class="p">,</span>
        <span class="n">ending_time</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;23:59&quot;</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">console_log</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bbstrader.log&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the Trade class with the specified parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            symbol (str): The `symbol` that the expert advisor will trade.</span>
<span class="sd">            expert_name (str): The name of the `expert advisor`.</span>
<span class="sd">            expert_id (int): The `unique ID` used to identify the expert advisor</span>
<span class="sd">                or the strategy used on the symbol.</span>
<span class="sd">            version (str): The `version` of the expert advisor.</span>
<span class="sd">            target (float): `Trading period (day, week, month) profit target` in percentage.</span>
<span class="sd">            start_time (str): The` hour and minutes` that the expert advisor is able to start to run.</span>
<span class="sd">            finishing_time (str): The time after which no new position can be opened.</span>
<span class="sd">            ending_time (str): The time after which any open position will be closed.</span>
<span class="sd">            verbose (bool | None): If set to None (default), account summary and risk managment</span>
<span class="sd">                parameters are printed in the terminal.</span>
<span class="sd">            console_log (bool): If set to True, log messages are displayed in the console.</span>
<span class="sd">            logger (Logger | str): The logger object to use for logging messages could be a string or a logger object.</span>

<span class="sd">        Inherits:</span>
<span class="sd">            -   max_risk</span>
<span class="sd">            -   max_trades</span>
<span class="sd">            -   rr</span>
<span class="sd">            -   daily_risk</span>
<span class="sd">            -   time_frame</span>
<span class="sd">            -   account_leverage</span>
<span class="sd">            -   std_stop</span>
<span class="sd">            -   pchange_sl</span>
<span class="sd">            -   sl</span>
<span class="sd">            -   tp</span>
<span class="sd">            -   be</span>
<span class="sd">        See the ``bbstrader.metatrader.risk.RiskManagement`` class for more details on these parameters.</span>
<span class="sd">        See `bbstrader.metatrader.account.check_mt5_connection()` for more details on how to connect to MT5 terminal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span>
            <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span>
            <span class="n">finishing_time</span><span class="o">=</span><span class="n">finishing_time</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expert_name</span> <span class="o">=</span> <span class="n">expert_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expert_id</span> <span class="o">=</span> <span class="n">expert_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">ending_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finishing</span> <span class="o">=</span> <span class="n">finishing_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console_log</span> <span class="o">=</span> <span class="n">console_log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tf</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time_frame&quot;</span><span class="p">,</span> <span class="s2">&quot;D1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">buy_positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sell_positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opened_positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opened_orders</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">break_even_status</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">break_even_points</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trail_after_points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_retcodes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_get_logger</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">console_log</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select_symbol</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_symbol</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">risk_managment</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&gt;&gt;&gt; Everything is OK, @</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expert_name</span><span class="si">}</span><span class="s2"> is Running ...&gt;&gt;&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">retcodes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all the retcodes&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retcodes</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">LOGGER</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loger</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">consol_log</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the logger object&quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">LOGGER</span>
        <span class="k">if</span> <span class="n">loger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="o">...</span>  <span class="c1"># Do nothing</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loger</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
            <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">config_logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BBSTRADER_DIR</span><span class="si">}</span><span class="s2">/logs/</span><span class="si">{</span><span class="n">loger</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">consol_log</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loger</span><span class="p">,</span> <span class="p">(</span><span class="n">Logger</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">log</span><span class="p">))):</span>
            <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">loger</span>

<div class="viewcode-block" id="Trade.initialize">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.initialize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the MetaTrader 5 (MT5) terminal for trading operations.</span>
<span class="sd">        This method attempts to establish a connection with the MT5 terminal.</span>
<span class="sd">        If the initial connection attempt fails due to a timeout, it retries after a specified delay.</span>
<span class="sd">        Successful initialization is crucial for the execution of trading operations.</span>

<span class="sd">        Raises:</span>
<span class="sd">            MT5TerminalError: If initialization fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Initializing the basics.&quot;</span><span class="p">)</span>
            <span class="n">check_mt5_connection</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;You are running the @</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expert_name</span><span class="si">}</span><span class="s2"> Expert advisor,&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; Version @</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2">, on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;During initialization: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.select_symbol">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.select_symbol">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">select_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Selects the trading symbol in the MetaTrader 5 (MT5) terminal.</span>
<span class="sd">        This method ensures that the specified trading</span>
<span class="sd">        symbol is selected and visible in the MT5 terminal,</span>
<span class="sd">        allowing subsequent trading operations such as opening and</span>
<span class="sd">        closing positions on this symbol.</span>

<span class="sd">        Raises:</span>
<span class="sd">            MT5TerminalError: If symbole selection fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">check_mt5_connection</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">symbol_select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="n">raise_mt5_error</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">INIT_MSG</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selecting symbol &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.prepare_symbol">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.prepare_symbol">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares the selected symbol for trading.</span>
<span class="sd">        This method checks if the symbol is available and visible in the</span>
<span class="sd">        MT5 terminal. If the symbol is not visible, it attempts to select the symbol again.</span>
<span class="sd">        This step ensures that trading operations can be performed on the selected symbol without issues.</span>

<span class="sd">        Raises:</span>
<span class="sd">            MT5TerminalError: If the symbol cannot be made visible for trading operations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">symbol_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">symbol_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">raise_mt5_error</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">INIT_MSG</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">symbol_info</span><span class="o">.</span><span class="n">visible</span><span class="p">:</span>
                <span class="n">raise_mt5_error</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">INIT_MSG</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initialization successfully completed.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preparing symbol &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.summary">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.summary">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show a brief description about the trading program&quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="s2">&quot;%H:%M&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">finish</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finishing</span><span class="p">,</span> <span class="s2">&quot;%H:%M&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="s2">&quot;%H:%M&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">summary_data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;Expert Advisor Name&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expert_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Expert Advisor Version&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Expert | Strategy ID&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expert_id</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Trading Symbol&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Trading Time Frame&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Start Trading Time&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Finishing Trading Time&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">finish</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Closing Position After&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
        <span class="p">]</span>
        <span class="c1"># Custom table format</span>
        <span class="n">summary_table</span> <span class="o">=</span> <span class="n">tabulate</span><span class="p">(</span>
            <span class="n">summary_data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Summary&quot;</span><span class="p">,</span> <span class="s2">&quot;Values&quot;</span><span class="p">],</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">&quot;outline&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Print the table</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[======= Trade Account Summary =======]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">summary_table</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.risk_managment">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.risk_managment">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">risk_managment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show the risk management parameters&quot;&quot;&quot;</span>

        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency_risk</span><span class="p">()[</span><span class="s2">&quot;trade_loss&quot;</span><span class="p">]</span>
        <span class="n">profit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency_risk</span><span class="p">()[</span><span class="s2">&quot;trade_profit&quot;</span><span class="p">]</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="s2">&quot;OK&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_risk_ok</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;Not OK&quot;</span>
        <span class="n">account_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_account_info</span><span class="p">()</span>
        <span class="n">_profit</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_stats</span><span class="p">()[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;total_profit&quot;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">currency</span> <span class="o">=</span> <span class="n">account_info</span><span class="o">.</span><span class="n">currency</span>
        <span class="n">rates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_currency_rates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">marging_currency</span> <span class="o">=</span> <span class="n">rates</span><span class="p">[</span><span class="s2">&quot;mc&quot;</span><span class="p">]</span>
        <span class="n">account_data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;Account Name&quot;</span><span class="p">,</span> <span class="n">account_info</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Account Number&quot;</span><span class="p">,</span> <span class="n">account_info</span><span class="o">.</span><span class="n">login</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Account Server&quot;</span><span class="p">,</span> <span class="n">account_info</span><span class="o">.</span><span class="n">server</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Account Balance&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">account_info</span><span class="o">.</span><span class="n">balance</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Account Profit&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_profit</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Account Equity&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">account_info</span><span class="o">.</span><span class="n">equity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Account Leverage&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_leverage</span><span class="p">(</span><span class="kc">True</span><span class="p">)],</span>
            <span class="p">[</span><span class="s2">&quot;Account Margin&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">account_info</span><span class="o">.</span><span class="n">margin</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Account Free Margin&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">account_info</span><span class="o">.</span><span class="n">margin_free</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Maximum Drawdown&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_risk</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Risk Allowed&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">max_risk</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">risk_level</span><span class="p">()),</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">marging_currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Risk Per trade&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">get_currency_risk</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Profit Expected Per trade&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expected_profit</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Lot Size&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_lot</span><span class="p">()</span><span class="si">}</span><span class="s2"> Lots&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Stop Loss&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_stop_loss</span><span class="p">()</span><span class="si">}</span><span class="s2"> Points&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Loss Value Per Tick&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Take Profit&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_take_profit</span><span class="p">()</span><span class="si">}</span><span class="s2"> Points&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Profit Value Per Tick&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">profit</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Break Even&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_break_even</span><span class="p">()</span><span class="si">}</span><span class="s2"> Points&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Deviation&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_deviation</span><span class="p">()</span><span class="si">}</span><span class="s2"> Points&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Trading Time Interval&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_minutes</span><span class="p">()</span><span class="si">}</span><span class="s2"> Minutes&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Risk Level&quot;</span><span class="p">,</span> <span class="n">ok</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Maximum Trades&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_trade</span><span class="p">()],</span>
        <span class="p">]</span>
        <span class="c1"># Custom table format</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[======= Account Risk Management Overview =======]&quot;</span><span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">tabulate</span><span class="p">(</span>
            <span class="n">account_data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Risk Metrics&quot;</span><span class="p">,</span> <span class="s2">&quot;Values&quot;</span><span class="p">],</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">&quot;outline&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Print the table</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">table</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.statistics">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.statistics">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print some statistics for the trading session and save to CSV if specified.</span>

<span class="sd">        Args:</span>
<span class="sd">            save (bool, optional): Whether to save the statistics to a CSV file.</span>
<span class="sd">            dir (str, optional): The directory to save the CSV file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stats</span><span class="p">,</span> <span class="n">additional_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stats</span><span class="p">()</span>

        <span class="n">profit</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;profit&quot;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">win_rate</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;win_rate&quot;</span><span class="p">]</span>
        <span class="n">total_fees</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;total_fees&quot;</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">average_fee</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;average_fee&quot;</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">currency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_account_info</span><span class="p">()</span><span class="o">.</span><span class="n">currency</span>
        <span class="n">net_profit</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">profit</span> <span class="o">+</span> <span class="n">total_fees</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">trade_risk</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_currency_risk</span><span class="p">()</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Formatting the statistics output</span>
        <span class="n">session_data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;Total Trades&quot;</span><span class="p">,</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;deals&quot;</span><span class="p">]],</span>
            <span class="p">[</span><span class="s2">&quot;Winning Trades&quot;</span><span class="p">,</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;win_trades&quot;</span><span class="p">]],</span>
            <span class="p">[</span><span class="s2">&quot;Losing Trades&quot;</span><span class="p">,</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;loss_trades&quot;</span><span class="p">]],</span>
            <span class="p">[</span><span class="s2">&quot;Session Profit&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">profit</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Total Fees&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">total_fees</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Average Fees&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">average_fee</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Net Profit&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">net_profit</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Risk per Trade&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">trade_risk</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Expected Profit per Trade&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expected_profit</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Risk Reward Ratio&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Win Rate&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">win_rate</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Sharpe Ratio&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sharpe</span><span class="p">()],</span>
            <span class="p">[</span><span class="s2">&quot;Trade Profitability&quot;</span><span class="p">,</span> <span class="n">additional_stats</span><span class="p">[</span><span class="s2">&quot;profitability&quot;</span><span class="p">]],</span>
        <span class="p">]</span>
        <span class="n">session_table</span> <span class="o">=</span> <span class="n">tabulate</span><span class="p">(</span>
            <span class="n">session_data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Statistics&quot;</span><span class="p">,</span> <span class="s2">&quot;Values&quot;</span><span class="p">],</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">&quot;outline&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[======= Trading Session Statistics =======]&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">session_table</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save</span> <span class="ow">and</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;deals&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">today_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H%M%S&quot;</span><span class="p">)</span>
            <span class="n">statistics_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">session_data</span><span class="p">}</span>
            <span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">statistics_dict</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="nb">dir</span> <span class="o">=</span> <span class="nb">dir</span> <span class="ow">or</span> <span class="s2">&quot;.sessions&quot;</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">:</span>
                <span class="n">symbol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">symbol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>

            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">today_date</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expert_id</span><span class="si">}</span><span class="s2">.csv&quot;</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">stats_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session statistics saved to </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.open_buy_position">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.open_buy_position">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">open_buy_position</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">action</span><span class="p">:</span> <span class="n">Buys</span> <span class="o">=</span> <span class="s2">&quot;BMKT&quot;</span><span class="p">,</span>
        <span class="n">price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stoplimit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">trail</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">comment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">symbol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">volume</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open a Buy position</span>

<span class="sd">        Args:</span>
<span class="sd">            action (str): `BMKT` for Market orders or `BLMT`,</span>
<span class="sd">                `BSTP`,`BSTPLMT` for pending orders</span>
<span class="sd">            price (float): The price at which to open an order</span>
<span class="sd">            stoplimit (float): A price a pending Limit order is set at when the price reaches</span>
<span class="sd">                the &#39;price&#39; value (this condition is mandatory).</span>
<span class="sd">                The pending order is not passed to the trading system until that moment</span>
<span class="sd">            id (int): The strategy id or expert Id</span>
<span class="sd">            mm (bool): Weither to put stop loss and tp or not</span>
<span class="sd">            trail (bool): Weither to trail the stop loss or not</span>
<span class="sd">            comment (str): The comment for the opening position</span>
<span class="sd">            volume (float): The volume (lot) to trade</span>
<span class="sd">            sl (float): The stop loss price</span>
<span class="sd">            tp (float): The take profit price</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Id</span> <span class="o">=</span> <span class="nb">id</span> <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">expert_id</span>
        <span class="n">point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">point</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">!=</span> <span class="s2">&quot;BMKT&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_price</span> <span class="o">=</span> <span class="n">price</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You need to set a price for pending orders&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tick_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">ask</span>

        <span class="n">lot</span> <span class="o">=</span> <span class="n">volume</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lot</span><span class="p">()</span>
        <span class="n">stop_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stop_loss</span><span class="p">()</span>
        <span class="n">take_profit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_take_profit</span><span class="p">()</span>
        <span class="n">deviation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_deviation</span><span class="p">()</span>
        <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_ACTION_DEAL</span><span class="p">,</span>
            <span class="s2">&quot;symbol&quot;</span><span class="p">:</span> <span class="n">symbol</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">lot</span><span class="p">),</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_BUY</span><span class="p">,</span>
            <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">_price</span><span class="p">,</span>
            <span class="s2">&quot;deviation&quot;</span><span class="p">:</span> <span class="n">deviation</span><span class="p">,</span>
            <span class="s2">&quot;magic&quot;</span><span class="p">:</span> <span class="n">Id</span><span class="p">,</span>
            <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="n">comment</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expert_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type_time&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TIME_GTC</span><span class="p">,</span>
            <span class="s2">&quot;type_filling&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_FILLING_FOK</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">mm_price</span> <span class="o">=</span> <span class="n">_price</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">!=</span> <span class="s2">&quot;BMKT&quot;</span><span class="p">:</span>
            <span class="n">request</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_ACTION_PENDING</span>
            <span class="n">request</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_type</span><span class="p">()[</span><span class="n">action</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;BSTPLMT&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stoplimit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You need to set a stoplimit price for BSTPLMT orders&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stoplimit</span> <span class="o">&gt;</span> <span class="n">_price</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Stoplimit price must be less than the price and greater than the current price&quot;</span>
                <span class="p">)</span>
            <span class="n">request</span><span class="p">[</span><span class="s2">&quot;stoplimit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stoplimit</span>
            <span class="n">mm_price</span> <span class="o">=</span> <span class="n">stoplimit</span>
        <span class="k">if</span> <span class="n">mm</span><span class="p">:</span>
            <span class="n">request</span><span class="p">[</span><span class="s2">&quot;sl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sl</span> <span class="ow">or</span> <span class="n">mm_price</span> <span class="o">-</span> <span class="n">stop_loss</span> <span class="o">*</span> <span class="n">point</span>
            <span class="n">request</span><span class="p">[</span><span class="s2">&quot;tp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span> <span class="ow">or</span> <span class="n">mm_price</span> <span class="o">+</span> <span class="n">take_profit</span> <span class="o">*</span> <span class="n">point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">break_even</span><span class="p">(</span><span class="n">mm</span><span class="o">=</span><span class="n">mm</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">Id</span><span class="p">,</span> <span class="n">trail</span><span class="o">=</span><span class="n">trail</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">comment</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_result</span><span class="p">(</span><span class="n">_price</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_order_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;BMKT&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_BUY</span><span class="p">,</span> <span class="s2">&quot;BUY&quot;</span><span class="p">),</span>
            <span class="s2">&quot;SMKT&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_BUY</span><span class="p">,</span> <span class="s2">&quot;SELL&quot;</span><span class="p">),</span>
            <span class="s2">&quot;BLMT&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_BUY_LIMIT</span><span class="p">,</span> <span class="s2">&quot;BUY_LIMIT&quot;</span><span class="p">),</span>
            <span class="s2">&quot;SLMT&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_SELL_LIMIT</span><span class="p">,</span> <span class="s2">&quot;SELL_LIMIT&quot;</span><span class="p">),</span>
            <span class="s2">&quot;BSTP&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_BUY_STOP</span><span class="p">,</span> <span class="s2">&quot;BUY_STOP&quot;</span><span class="p">),</span>
            <span class="s2">&quot;SSTP&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_SELL_STOP</span><span class="p">,</span> <span class="s2">&quot;SELL_STOP&quot;</span><span class="p">),</span>
            <span class="s2">&quot;BSTPLMT&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_BUY_STOP_LIMIT</span><span class="p">,</span> <span class="s2">&quot;BUY_STOP_LIMIT&quot;</span><span class="p">),</span>
            <span class="s2">&quot;SSTPLMT&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_SELL_STOP_LIMIT</span><span class="p">,</span> <span class="s2">&quot;SELL_STOP_LIMIT&quot;</span><span class="p">),</span>
        <span class="p">}</span>

<div class="viewcode-block" id="Trade.open_sell_position">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.open_sell_position">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">open_sell_position</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">action</span><span class="p">:</span> <span class="n">Sells</span> <span class="o">=</span> <span class="s2">&quot;SMKT&quot;</span><span class="p">,</span>
        <span class="n">price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stoplimit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">trail</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">comment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">symbol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">volume</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open a sell position</span>

<span class="sd">        Args:</span>
<span class="sd">            action (str): `SMKT` for Market orders</span>
<span class="sd">                or ``SLMT``, ``SSTP``,``SSTPLMT`` for pending orders</span>
<span class="sd">            price (float): The price at which to open an order</span>
<span class="sd">            stoplimit (float): A price a pending Limit order is set at when the price reaches</span>
<span class="sd">                the &#39;price&#39; value (this condition is mandatory).</span>
<span class="sd">                The pending order is not passed to the trading system until that moment</span>
<span class="sd">            id (int): The strategy id or expert Id</span>
<span class="sd">            mm (bool): Weither to put stop loss and tp or not</span>
<span class="sd">            trail (bool): Weither to trail the stop loss or not</span>
<span class="sd">            comment (str): The comment for the closing position</span>
<span class="sd">            volume (float): The volume (lot) to trade</span>
<span class="sd">            sl (float): The stop loss price</span>
<span class="sd">            tp (float): The take profit price</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Id</span> <span class="o">=</span> <span class="nb">id</span> <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">expert_id</span>
        <span class="n">point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">point</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">!=</span> <span class="s2">&quot;SMKT&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_price</span> <span class="o">=</span> <span class="n">price</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You need to set a price for pending orders&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tick_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">bid</span>

        <span class="n">lot</span> <span class="o">=</span> <span class="n">volume</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lot</span><span class="p">()</span>
        <span class="n">stop_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stop_loss</span><span class="p">()</span>
        <span class="n">take_profit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_take_profit</span><span class="p">()</span>
        <span class="n">deviation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_deviation</span><span class="p">()</span>
        <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_ACTION_DEAL</span><span class="p">,</span>
            <span class="s2">&quot;symbol&quot;</span><span class="p">:</span> <span class="n">symbol</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">lot</span><span class="p">),</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_SELL</span><span class="p">,</span>
            <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">_price</span><span class="p">,</span>
            <span class="s2">&quot;deviation&quot;</span><span class="p">:</span> <span class="n">deviation</span><span class="p">,</span>
            <span class="s2">&quot;magic&quot;</span><span class="p">:</span> <span class="n">Id</span><span class="p">,</span>
            <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="n">comment</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expert_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type_time&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TIME_GTC</span><span class="p">,</span>
            <span class="s2">&quot;type_filling&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_FILLING_FOK</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">mm_price</span> <span class="o">=</span> <span class="n">_price</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">!=</span> <span class="s2">&quot;SMKT&quot;</span><span class="p">:</span>
            <span class="n">request</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_ACTION_PENDING</span>
            <span class="n">request</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_type</span><span class="p">()[</span><span class="n">action</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;SSTPLMT&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stoplimit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You need to set a stoplimit price for SSTPLMT orders&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stoplimit</span> <span class="o">&lt;</span> <span class="n">_price</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Stoplimit price must be greater than the price and less than the current price&quot;</span>
                <span class="p">)</span>
            <span class="n">request</span><span class="p">[</span><span class="s2">&quot;stoplimit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stoplimit</span>
            <span class="n">mm_price</span> <span class="o">=</span> <span class="n">stoplimit</span>
        <span class="k">if</span> <span class="n">mm</span><span class="p">:</span>
            <span class="n">request</span><span class="p">[</span><span class="s2">&quot;sl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sl</span> <span class="ow">or</span> <span class="n">mm_price</span> <span class="o">+</span> <span class="n">stop_loss</span> <span class="o">*</span> <span class="n">point</span>
            <span class="n">request</span><span class="p">[</span><span class="s2">&quot;tp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span> <span class="ow">or</span> <span class="n">mm_price</span> <span class="o">-</span> <span class="n">take_profit</span> <span class="o">*</span> <span class="n">point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">break_even</span><span class="p">(</span><span class="n">mm</span><span class="o">=</span><span class="n">mm</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">Id</span><span class="p">,</span> <span class="n">trail</span><span class="o">=</span><span class="n">trail</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">comment</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_result</span><span class="p">(</span><span class="n">_price</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Trade.check">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.check">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comment</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify if all conditions for taking a position are valide,</span>
<span class="sd">        These conditions are based on the Maximum risk ,daily risk,</span>
<span class="sd">        the starting, the finishing, and ending trading time.</span>

<span class="sd">        Args:</span>
<span class="sd">            comment (str): The comment for the closing position</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy_mode</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">days_end</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trading_time</span><span class="p">():</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not Trading time, SYMBOL=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_risk_ok</span><span class="p">():</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Account Risk not allowed, SYMBOL=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_max_trades_reached</span><span class="p">():</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Maximum trades reached for Today, SYMBOL=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">profit_target</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Profit target Reached !!! SYMBOL=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">positive_profit</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">expert_id</span><span class="p">)</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_positions</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_positions</span><span class="p">(</span><span class="n">position_type</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistics</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="Trade.request_result">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.request_result">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">request_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Buys</span> <span class="o">|</span> <span class="n">Sells</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a trading order has been sent correctly</span>

<span class="sd">        Args:</span>
<span class="sd">            price (float): Price for opening the position</span>
<span class="sd">            request (Dict[str, Any]): A trade request to sent to Mt5.order_sent()</span>
<span class="sd">            all detail in request can be found here https://www.mql5.com/en/docs/python_metatrader5/mt5ordersend_py</span>

<span class="sd">            type (str): The type of the order `(BMKT, SMKT, BLMT, SLMT, BSTP, SSTP, BSTPLMT, SSTPLMT)`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Send a trading request</span>
        <span class="c1"># Check the execution result</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_type</span><span class="p">()[</span><span class="nb">type</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">addtionnal</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;, SYMBOL=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_datetime</span><span class="p">()</span><span class="si">}</span><span class="s2"> -&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">trade_retcode_message</span><span class="p">(</span>
                <span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}{</span><span class="n">addtionnal</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">!=</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_INVALID_FILL</span><span class="p">:</span>  <span class="c1"># 10030</span>
                <span class="k">for</span> <span class="n">fill</span> <span class="ow">in</span> <span class="n">FILLING_TYPE</span><span class="p">:</span>
                    <span class="n">request</span><span class="p">[</span><span class="s2">&quot;type_filling&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">elif</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_INVALID_VOLUME</span><span class="p">:</span>  <span class="c1"># 10014</span>
                <span class="n">new_volume</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">new_volume</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">request</span><span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_volume</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retcodes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_retcodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">trade_retcode_message</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">)</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Trade Order Request, RETCODE=</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">msg</span><span class="si">}{</span><span class="n">addtionnal</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_CONNECTION</span><span class="p">,</span>
                <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_TIMEOUT</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">!=</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span> <span class="ow">and</span> <span class="n">tries</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">check_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_datetime</span><span class="p">()</span><span class="si">}</span><span class="s2"> -&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                        <span class="n">trade_retcode_message</span><span class="p">(</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}{</span><span class="n">addtionnal</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">tries</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># Print the result</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">trade_retcode_message</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trade Order </span><span class="si">{</span><span class="n">msg</span><span class="si">}{</span><span class="n">addtionnal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span> <span class="o">!=</span> <span class="s2">&quot;BMKT&quot;</span> <span class="ow">or</span> <span class="nb">type</span> <span class="o">!=</span> <span class="s2">&quot;SMKT&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">opened_orders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
            <span class="n">long_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;1. </span><span class="si">{</span><span class="n">pos</span><span class="si">}</span><span class="s2"> Order #</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">order</span><span class="si">}</span><span class="s2"> Sent, Symbol: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">, Price: @</span><span class="si">{</span><span class="n">price</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Lot(s): </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">volume</span><span class="si">}</span><span class="s2">, Sl: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_stop_loss</span><span class="p">()</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Tp: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_take_profit</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">long_msg</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;BMKT&quot;</span> <span class="ow">or</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;SMKT&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">opened_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
                <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_positions</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">ticket</span> <span class="o">==</span> <span class="n">result</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">order_type</span> <span class="o">=</span> <span class="s2">&quot;BUY&quot;</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">buy_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">ticket</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">order_type</span> <span class="o">=</span> <span class="s2">&quot;SELL&quot;</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sell_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">ticket</span><span class="p">)</span>
                            <span class="n">profit</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_account_info</span><span class="p">()</span><span class="o">.</span><span class="n">profit</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
                            <span class="n">order_info</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;2. </span><span class="si">{</span><span class="n">order_type</span><span class="si">}</span><span class="s2"> Position Opened, Symbol: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">, Price: @</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">price_open</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;Sl: @</span><span class="si">{</span><span class="n">position</span><span class="o">.</span><span class="n">sl</span><span class="si">}</span><span class="s2"> Tp: @</span><span class="si">{</span><span class="n">position</span><span class="o">.</span><span class="n">tp</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">order_info</span><span class="p">)</span>
                            <span class="n">pos_info</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;3. [OPEN POSITIONS ON </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span><span class="si">}</span><span class="s2">, ACCOUNT OPEN PnL = </span><span class="si">{</span><span class="n">profit</span><span class="si">}</span><span class="s2"> &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_account_info</span><span class="p">()</span><span class="o">.</span><span class="n">currency</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">pos_info</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">trade_retcode_message</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unable to Open Position, RETCODE=</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">msg</span><span class="si">}{</span><span class="n">addtionnal</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Trade.open_position">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.open_position">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">open_position</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">action</span><span class="p">:</span> <span class="n">Buys</span> <span class="o">|</span> <span class="n">Sells</span><span class="p">,</span>
        <span class="n">price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stoplimit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">trail</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">comment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">symbol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">volume</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open a buy or sell position.</span>

<span class="sd">        Args:</span>
<span class="sd">            action (str): (`&#39;BMKT&#39;`, `&#39;SMKT&#39;`) for Market orders</span>
<span class="sd">                or (`&#39;BLMT&#39;, &#39;SLMT&#39;, &#39;BSTP&#39;, &#39;SSTP&#39;, &#39;BSTPLMT&#39;, &#39;SSTPLMT&#39;`) for pending orders</span>
<span class="sd">            price (float): The price at which to open an order</span>
<span class="sd">            stoplimit (float): A price a pending Limit order is set at</span>
<span class="sd">                when the price reaches the &#39;price&#39; value (this condition is mandatory).</span>
<span class="sd">                The pending order is not passed to the trading system until that moment</span>
<span class="sd">            id (int): The strategy id or expert Id</span>
<span class="sd">            mm (bool): Weither to put stop loss and tp or not</span>
<span class="sd">            trail (bool): Weither to trail the stop loss or not</span>
<span class="sd">            comment (str): The comment for the closing position</span>
<span class="sd">            symbol (str): The symbol to trade</span>
<span class="sd">            volume (float): The volume (lot) to trade</span>
<span class="sd">            sl (float): The stop loss price</span>
<span class="sd">            tp (float): The take profit price</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">BUYS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;BMKT&quot;</span><span class="p">,</span> <span class="s2">&quot;BLMT&quot;</span><span class="p">,</span> <span class="s2">&quot;BSTP&quot;</span><span class="p">,</span> <span class="s2">&quot;BSTPLMT&quot;</span><span class="p">]</span>
        <span class="n">SELLS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SMKT&quot;</span><span class="p">,</span> <span class="s2">&quot;SLMT&quot;</span><span class="p">,</span> <span class="s2">&quot;SSTP&quot;</span><span class="p">,</span> <span class="s2">&quot;SSTPLMT&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">BUYS</span><span class="p">:</span>
            <span class="n">open_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_buy_position</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">SELLS</span><span class="p">:</span>
            <span class="n">open_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_sell_position</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid action type &#39;</span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&#39;, must be </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BUYS</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">SELLS</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">open_position</span><span class="p">(</span>
            <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span>
            <span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span>
            <span class="n">stoplimit</span><span class="o">=</span><span class="n">stoplimit</span><span class="p">,</span>
            <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
            <span class="n">mm</span><span class="o">=</span><span class="n">mm</span><span class="p">,</span>
            <span class="n">trail</span><span class="o">=</span><span class="n">trail</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">,</span>
            <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span>
            <span class="n">volume</span><span class="o">=</span><span class="n">volume</span><span class="p">,</span>
            <span class="n">sl</span><span class="o">=</span><span class="n">sl</span><span class="p">,</span>
            <span class="n">tp</span><span class="o">=</span><span class="n">tp</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">orders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all opened order&#39;s tickets&quot;&quot;&quot;</span>
        <span class="n">current_orders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_orders</span><span class="p">()</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">opened_orders</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">current_orders</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">opened_orders</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">opened_orders</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opened_orders</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all opened position&#39;s tickets&quot;&quot;&quot;</span>
        <span class="n">current_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_positions</span><span class="p">()</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">opened_positions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">current_positions</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">opened_positions</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">opened_positions</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opened_positions</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">buypos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all buy  opened position&#39;s tickets&quot;&quot;&quot;</span>
        <span class="n">buy_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_buys</span><span class="p">()</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">buy_positions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">buy_positions</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">buy_positions</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">buy_positions</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buy_positions</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sellpos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all sell  opened position&#39;s tickets&quot;&quot;&quot;</span>
        <span class="n">sell_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_sells</span><span class="p">()</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">sell_positions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">sell_positions</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sell_positions</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">sell_positions</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sell_positions</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bepos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return All positon&#39;s tickets</span>
<span class="sd">        for which a break even has been set&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">break_even_status</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">break_even_status</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="Trade.get_filtered_tickets">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.get_filtered_tickets">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_filtered_tickets</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">filter_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">th</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get tickets for positions or orders based on filters.</span>

<span class="sd">        Args:</span>
<span class="sd">            id (int): The strategy id or expert Id</span>
<span class="sd">            filter_type (str): Filter type to apply on the tickets,</span>
<span class="sd">                - `orders` are current open orders</span>
<span class="sd">                - `buy_stops` are current buy stop orders</span>
<span class="sd">                - `sell_stops` are current sell stop orders</span>
<span class="sd">                - `buy_limits` are current buy limit orders</span>
<span class="sd">                - `sell_limits` are current sell limit orders</span>
<span class="sd">                - `buy_stop_limits` are current buy stop limit orders</span>
<span class="sd">                - `sell_stop_limits` are current sell stop limit orders</span>
<span class="sd">                - `positions` are all current open positions</span>
<span class="sd">                - `buys` and `sells` are current buy or sell open positions</span>
<span class="sd">                - `profitables` are current open position that have a profit greater than a threshold</span>
<span class="sd">                - `losings` are current open position that have a negative profit</span>
<span class="sd">            th (bool): the minimum treshold for winning position</span>
<span class="sd">                (only relevant when filter_type is &#39;profitables&#39;)</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[int] | None: A list of filtered tickets</span>
<span class="sd">                or None if no tickets match the criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Id</span> <span class="o">=</span> <span class="nb">id</span> <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">expert_id</span>
        <span class="n">POSITIONS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;positions&quot;</span><span class="p">,</span> <span class="s2">&quot;buys&quot;</span><span class="p">,</span> <span class="s2">&quot;sells&quot;</span><span class="p">,</span> <span class="s2">&quot;profitables&quot;</span><span class="p">,</span> <span class="s2">&quot;losings&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">filter_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">POSITIONS</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_orders</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_positions</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>

        <span class="n">filtered_tickets</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">items</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">magic</span> <span class="o">==</span> <span class="n">Id</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">filter_type</span> <span class="o">==</span> <span class="s2">&quot;buys&quot;</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">filter_type</span> <span class="o">==</span> <span class="s2">&quot;sells&quot;</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">filter_type</span> <span class="o">==</span> <span class="s2">&quot;losings&quot;</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">profit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">filter_type</span> <span class="o">==</span> <span class="s2">&quot;profitables&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">win_trade</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">th</span><span class="o">=</span><span class="n">th</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">filter_type</span> <span class="o">==</span> <span class="s2">&quot;buy_stops&quot;</span>
                        <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_type</span><span class="p">()[</span><span class="s2">&quot;BSTP&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">filter_type</span> <span class="o">==</span> <span class="s2">&quot;sell_stops&quot;</span>
                        <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_type</span><span class="p">()[</span><span class="s2">&quot;SSTP&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">filter_type</span> <span class="o">==</span> <span class="s2">&quot;buy_limits&quot;</span>
                        <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_type</span><span class="p">()[</span><span class="s2">&quot;BLMT&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">filter_type</span> <span class="o">==</span> <span class="s2">&quot;sell_limits&quot;</span>
                        <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_type</span><span class="p">()[</span><span class="s2">&quot;SLMT&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">filter_type</span> <span class="o">==</span> <span class="s2">&quot;buy_stop_limits&quot;</span>
                        <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_type</span><span class="p">()[</span><span class="s2">&quot;BSTPLMT&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">filter_type</span> <span class="o">==</span> <span class="s2">&quot;sell_stop_limits&quot;</span>
                        <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_type</span><span class="p">()[</span><span class="s2">&quot;SSTPLMT&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">filtered_tickets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">ticket</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">filtered_tickets</span> <span class="k">if</span> <span class="n">filtered_tickets</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Trade.get_current_orders">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.get_current_orders">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtered_tickets</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s2">&quot;orders&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.get_current_buy_stops">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.get_current_buy_stops">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_buy_stops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtered_tickets</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s2">&quot;buy_stops&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.get_current_sell_stops">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.get_current_sell_stops">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_sell_stops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtered_tickets</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s2">&quot;sell_stops&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.get_current_buy_limits">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.get_current_buy_limits">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_buy_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtered_tickets</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s2">&quot;buy_limits&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.get_current_sell_limits">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.get_current_sell_limits">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_sell_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtered_tickets</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s2">&quot;sell_limits&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.get_current_buy_stop_limits">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.get_current_buy_stop_limits">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_buy_stop_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtered_tickets</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s2">&quot;buy_stop_limits&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.get_current_sell_stop_limits">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.get_current_sell_stop_limits">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_sell_stop_limits</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtered_tickets</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s2">&quot;sell_stop_limits&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.get_current_positions">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.get_current_positions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtered_tickets</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s2">&quot;positions&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.get_current_profitables">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.get_current_profitables">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_profitables</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">th</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtered_tickets</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s2">&quot;profitables&quot;</span><span class="p">,</span> <span class="n">th</span><span class="o">=</span><span class="n">th</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.get_current_losings">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.get_current_losings">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_losings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtered_tickets</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s2">&quot;losings&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.get_current_buys">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.get_current_buys">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_buys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtered_tickets</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s2">&quot;buys&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.get_current_sells">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.get_current_sells">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_sells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filtered_tickets</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s2">&quot;sells&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.positive_profit">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.positive_profit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">positive_profit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">th</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">account</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check is the total profit on current open positions</span>
<span class="sd">        Is greater than a minimum profit express as percentage</span>
<span class="sd">        of the profit target.</span>

<span class="sd">        Args:</span>
<span class="sd">            th (float): The minimum profit target on current positions</span>
<span class="sd">            id (int): The strategy id or expert Id</span>
<span class="sd">            account (bool): Weither to check positions on the account or on the symbol</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">account</span> <span class="ow">and</span> <span class="nb">id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># All open positions no matter the symbol or strategy or expert</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">account</span> <span class="ow">and</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># All open positions for a specific strategy or expert no matter the symbol</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">position</span> <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">positions</span> <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">magic</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">account</span> <span class="ow">and</span> <span class="nb">id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># All open positions for the current symbol no matter the strategy or expert</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_positions</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">account</span> <span class="ow">and</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># All open positions for the current symbol and a specific strategy or expert</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_positions</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">position</span> <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">positions</span> <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">magic</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">profit</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_account_info</span><span class="p">()</span><span class="o">.</span><span class="n">balance</span>
            <span class="n">target</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">balance</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
                <span class="n">profit</span> <span class="o">+=</span> <span class="n">position</span><span class="o">.</span><span class="n">profit</span>
            <span class="n">fees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stats</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;average_fee&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
            <span class="n">current_profit</span> <span class="o">=</span> <span class="n">profit</span> <span class="o">+</span> <span class="n">fees</span>
            <span class="n">th_profit</span> <span class="o">=</span> <span class="p">(</span><span class="n">target</span> <span class="o">*</span> <span class="n">th</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">th</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">target</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">current_profit</span> <span class="o">&gt;=</span> <span class="n">th_profit</span>
        <span class="k">return</span> <span class="kc">False</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_trail_after_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trail_after_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trail_after_points</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">trail_after_points</span> <span class="o">==</span> <span class="s2">&quot;SL&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stop_loss</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">trail_after_points</span> <span class="o">==</span> <span class="s2">&quot;TP&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_take_profit</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">trail_after_points</span> <span class="o">==</span> <span class="s2">&quot;BE&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_break_even</span><span class="p">()</span>
        <span class="c1"># TODO: Add other combinations (e.g. &quot;SL+TP&quot;, &quot;SL+BE&quot;, &quot;TP+BE&quot;, &quot;SL*N&quot;, etc.)</span>
        <span class="k">return</span> <span class="n">trail_after_points</span>

<div class="viewcode-block" id="Trade.break_even">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.break_even">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">break_even</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">trail</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">stop_trail</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">trail_after_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">be_plus_points</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manages the break-even level of a trading position.</span>

<span class="sd">        This function checks whether it is time to set a break-even stop loss for an open position.</span>
<span class="sd">        If the break-even level is already set, it monitors price movement and updates the stop loss</span>
<span class="sd">        accordingly if the `trail` parameter is enabled.</span>

<span class="sd">        When `trail` is enabled, the function dynamically adjusts the break-even level based on the</span>
<span class="sd">        `trail_after_points` and `stop_trail` parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            id (int): The strategy ID or expert ID.</span>
<span class="sd">            mm (bool): Whether to manage the position or not.</span>
<span class="sd">            trail (bool): Whether to trail the stop loss or not.</span>
<span class="sd">            stop_trail (int): Number of points to trail the stop loss by.</span>
<span class="sd">                It represent the distance from the current price to the stop loss.</span>
<span class="sd">            trail_after_points (int, str): Number of points in profit</span>
<span class="sd">                from where the strategy will start to trail the stop loss.</span>
<span class="sd">                If set to str, it must be one of the following values:</span>
<span class="sd">                - &#39;SL&#39; to trail the stop loss after the profit reaches the stop loss level in points.</span>
<span class="sd">                - &#39;TP&#39; to trail the stop loss after the profit reaches the take profit level in points.</span>
<span class="sd">                - &#39;BE&#39; to trail the stop loss after the profit reaches the break-even level in points.</span>
<span class="sd">            be_plus_points (int): Number of points to add to the break-even level.</span>
<span class="sd">                Represents the minimum profit to secure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mm</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">Id</span> <span class="o">=</span> <span class="nb">id</span> <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">expert_id</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_positions</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">be</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_break_even</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">trail_after_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trail_after_points</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">assert</span> <span class="p">(</span>
                    <span class="n">trail_after_points</span> <span class="o">&gt;</span> <span class="n">be</span>
                <span class="p">),</span> <span class="s2">&quot;trail_after_points must be greater than break even or set to None&quot;</span>
            <span class="n">trail_after_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_trail_after_points</span><span class="p">(</span><span class="n">trail_after_points</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">magic</span> <span class="o">==</span> <span class="n">Id</span><span class="p">:</span>
                    <span class="n">symbol_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="n">symbol_info</span><span class="o">.</span><span class="n">trade_tick_size</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">symbol_info</span><span class="o">.</span><span class="n">trade_tick_value</span>
                    <span class="n">point</span> <span class="o">=</span> <span class="n">symbol_info</span><span class="o">.</span><span class="n">point</span>
                    <span class="n">digits</span> <span class="o">=</span> <span class="n">symbol_info</span><span class="o">.</span><span class="n">digits</span>
                    <span class="n">points</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">profit</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">/</span> <span class="n">value</span> <span class="o">/</span> <span class="n">position</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span>
                    <span class="n">break_even</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">points</span> <span class="o">/</span> <span class="n">point</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">be</span>
                    <span class="k">if</span> <span class="n">break_even</span><span class="p">:</span>
                        <span class="c1"># Check if break-even has already been set for this position</span>
                        <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">ticket</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">break_even_status</span><span class="p">:</span>
                            <span class="n">price</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">if</span> <span class="n">be_plus_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">price</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">price_open</span> <span class="o">+</span> <span class="p">(</span><span class="n">be_plus_points</span> <span class="o">*</span> <span class="n">point</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">set_break_even</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">break_even_status</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">ticket</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">break_even_points</span><span class="p">[</span><span class="n">position</span><span class="o">.</span><span class="n">ticket</span><span class="p">]</span> <span class="o">=</span> <span class="n">be</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Skip this if the trail is not set to True</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">trail</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="c1"># Check if the price has moved favorably</span>
                            <span class="n">new_be</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="nb">round</span><span class="p">(</span><span class="n">be</span> <span class="o">*</span> <span class="mf">0.10</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">be_plus_points</span> <span class="ow">is</span> <span class="kc">None</span>
                                <span class="k">else</span> <span class="n">be_plus_points</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="n">trail_after_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">ticket</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trail_after_points</span><span class="p">:</span>
                                    <span class="c1"># This ensures that the position rich the minimum points required</span>
                                    <span class="c1"># before the trail can be set</span>
                                    <span class="n">new_be</span> <span class="o">=</span> <span class="n">trail_after_points</span> <span class="o">-</span> <span class="n">be</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">trail_after_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">ticket</span><span class="p">)</span>
                            <span class="n">new_be_points</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">break_even_points</span><span class="p">[</span><span class="n">position</span><span class="o">.</span><span class="n">ticket</span><span class="p">]</span> <span class="o">+</span> <span class="n">new_be</span>
                            <span class="p">)</span>
                            <span class="n">favorable_move</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">points</span> <span class="o">/</span> <span class="n">point</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">new_be_points</span>
                            <span class="k">if</span> <span class="n">favorable_move</span><span class="p">:</span>
                                <span class="c1"># This allows the position to go to take profit in case of a swing trade</span>
                                <span class="c1"># If is a scalping position, we can set the stop_trail close to the current price.</span>
                                <span class="n">trail_points</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="nb">round</span><span class="p">(</span><span class="n">be</span> <span class="o">*</span> <span class="mf">0.50</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">stop_trail</span> <span class="ow">is</span> <span class="kc">None</span>
                                    <span class="k">else</span> <span class="n">stop_trail</span>
                                <span class="p">)</span>
                                <span class="c1"># Calculate the new break-even level and price</span>
                                <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="c1"># This level validate the favorable move of the price</span>
                                    <span class="n">new_level</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
                                        <span class="n">position</span><span class="o">.</span><span class="n">price_open</span> <span class="o">+</span> <span class="p">(</span><span class="n">new_be_points</span> <span class="o">*</span> <span class="n">point</span><span class="p">),</span>
                                        <span class="n">digits</span><span class="p">,</span>
                                    <span class="p">)</span>
                                    <span class="c1"># This price is set away from the current price by the trail_points</span>
                                    <span class="n">new_price</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
                                        <span class="n">position</span><span class="o">.</span><span class="n">price_current</span> <span class="o">-</span> <span class="p">(</span><span class="n">trail_points</span> <span class="o">*</span> <span class="n">point</span><span class="p">),</span>
                                        <span class="n">digits</span><span class="p">,</span>
                                    <span class="p">)</span>
                                    <span class="k">if</span> <span class="n">new_price</span> <span class="o">&lt;</span> <span class="n">position</span><span class="o">.</span><span class="n">sl</span><span class="p">:</span>
                                        <span class="n">new_price</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">sl</span>
                                <span class="k">elif</span> <span class="n">position</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">new_level</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
                                        <span class="n">position</span><span class="o">.</span><span class="n">price_open</span> <span class="o">-</span> <span class="p">(</span><span class="n">new_be_points</span> <span class="o">*</span> <span class="n">point</span><span class="p">),</span>
                                        <span class="n">digits</span><span class="p">,</span>
                                    <span class="p">)</span>
                                    <span class="n">new_price</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
                                        <span class="n">position</span><span class="o">.</span><span class="n">price_current</span> <span class="o">+</span> <span class="p">(</span><span class="n">trail_points</span> <span class="o">*</span> <span class="n">point</span><span class="p">),</span>
                                        <span class="n">digits</span><span class="p">,</span>
                                    <span class="p">)</span>
                                    <span class="k">if</span> <span class="n">new_price</span> <span class="o">&gt;</span> <span class="n">position</span><span class="o">.</span><span class="n">sl</span><span class="p">:</span>
                                        <span class="n">new_price</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">sl</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">set_break_even</span><span class="p">(</span>
                                    <span class="n">position</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="n">new_price</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">new_level</span>
                                <span class="p">)</span></div>


<div class="viewcode-block" id="Trade.set_break_even">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.set_break_even">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_break_even</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">position</span><span class="p">:</span> <span class="n">TradePosition</span><span class="p">,</span>
        <span class="n">be</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the break-even level for a given trading position.</span>

<span class="sd">        Args:</span>
<span class="sd">            position (TradePosition): The trading position for which the break-even is to be set.</span>
<span class="sd">                This is the value return by `mt5.positions_get()`.</span>
<span class="sd">            be (int): The break-even level in points.</span>
<span class="sd">            level (float): The break-even level in price, if set to None , it will be calated automaticaly.</span>
<span class="sd">            price (float): The break-even price, if set to None , it will be calated automaticaly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">point</span>
        <span class="n">digits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">digits</span>
        <span class="n">spread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">spread</span>
        <span class="n">fees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stats</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;average_fee&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency_risk</span><span class="p">()[</span><span class="s2">&quot;trade_profit&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fees_points</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">fees</span> <span class="o">/</span> <span class="n">risk</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
            <span class="n">fees_points</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># If Buy</span>
        <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">position</span><span class="o">.</span><span class="n">price_current</span> <span class="o">&gt;</span> <span class="n">position</span><span class="o">.</span><span class="n">price_open</span><span class="p">:</span>
            <span class="c1"># Calculate the break-even level and price</span>
            <span class="n">break_even_level</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">price_open</span> <span class="o">+</span> <span class="p">(</span><span class="n">be</span> <span class="o">*</span> <span class="n">point</span><span class="p">)</span>
            <span class="n">break_even_price</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">price_open</span> <span class="o">+</span> <span class="p">((</span><span class="n">fees_points</span> <span class="o">+</span> <span class="n">spread</span><span class="p">)</span> <span class="o">*</span> <span class="n">point</span><span class="p">)</span>
            <span class="c1"># Check if the price specified is greater or lower than the calculated price</span>
            <span class="n">_price</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">break_even_price</span> <span class="k">if</span> <span class="n">price</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="n">break_even_price</span> <span class="k">else</span> <span class="n">price</span>
            <span class="p">)</span>
            <span class="n">_level</span> <span class="o">=</span> <span class="n">break_even_level</span> <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">level</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tick_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">ask</span> <span class="o">&gt;</span> <span class="n">_level</span><span class="p">:</span>
                <span class="c1"># Set the stop loss to break even</span>
                <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_ACTION_SLTP</span><span class="p">,</span>
                    <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="n">position</span><span class="o">.</span><span class="n">ticket</span><span class="p">,</span>
                    <span class="s2">&quot;sl&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">_price</span><span class="p">,</span> <span class="n">digits</span><span class="p">),</span>
                    <span class="s2">&quot;tp&quot;</span><span class="p">:</span> <span class="n">position</span><span class="o">.</span><span class="n">tp</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">break_even_request</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">ticket</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">_price</span><span class="p">,</span> <span class="n">digits</span><span class="p">),</span> <span class="n">request</span><span class="p">)</span>
        <span class="c1"># If Sell</span>
        <span class="k">elif</span> <span class="n">position</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">position</span><span class="o">.</span><span class="n">price_current</span> <span class="o">&lt;</span> <span class="n">position</span><span class="o">.</span><span class="n">price_open</span><span class="p">:</span>
            <span class="n">break_even_level</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">price_open</span> <span class="o">-</span> <span class="p">(</span><span class="n">be</span> <span class="o">*</span> <span class="n">point</span><span class="p">)</span>
            <span class="n">break_even_price</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">price_open</span> <span class="o">-</span> <span class="p">((</span><span class="n">fees_points</span> <span class="o">+</span> <span class="n">spread</span><span class="p">)</span> <span class="o">*</span> <span class="n">point</span><span class="p">)</span>
            <span class="n">_price</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">break_even_price</span> <span class="k">if</span> <span class="n">price</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="n">break_even_price</span> <span class="k">else</span> <span class="n">price</span>
            <span class="p">)</span>
            <span class="n">_level</span> <span class="o">=</span> <span class="n">break_even_level</span> <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">level</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tick_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">bid</span> <span class="o">&lt;</span> <span class="n">_level</span><span class="p">:</span>
                <span class="c1"># Set the stop loss to break even</span>
                <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_ACTION_SLTP</span><span class="p">,</span>
                    <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="n">position</span><span class="o">.</span><span class="n">ticket</span><span class="p">,</span>
                    <span class="s2">&quot;sl&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">_price</span><span class="p">,</span> <span class="n">digits</span><span class="p">),</span>
                    <span class="s2">&quot;tp&quot;</span><span class="p">:</span> <span class="n">position</span><span class="o">.</span><span class="n">tp</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">break_even_request</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">ticket</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">_price</span><span class="p">,</span> <span class="n">digits</span><span class="p">),</span> <span class="n">request</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.break_even_request">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.break_even_request">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">break_even_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tiket</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a request to set the stop loss to break even for a given trading position.</span>

<span class="sd">        Args:</span>
<span class="sd">            tiket (int): The ticket number of the trading position.</span>
<span class="sd">            price (float): The price at which the stop loss is to be set.</span>
<span class="sd">            request (dict): The request to set the stop loss to break even.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">addtionnal</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;, SYMBOL=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_datetime</span><span class="p">()</span><span class="si">}</span><span class="s2"> -&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">trade_retcode_message</span><span class="p">(</span>
                <span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}{</span><span class="n">addtionnal</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">!=</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">trade_retcode_message</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">!=</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_NO_CHANGES</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Break-Even Order Request, Position: #</span><span class="si">{</span><span class="n">tiket</span><span class="si">}</span><span class="s2">, RETCODE=</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">msg</span><span class="si">}{</span><span class="n">addtionnal</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">!=</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span> <span class="ow">and</span> <span class="n">tries</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_NO_CHANGES</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">check_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_datetime</span><span class="p">()</span><span class="si">}</span><span class="s2"> -&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                        <span class="n">trade_retcode_message</span><span class="p">(</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}{</span><span class="n">addtionnal</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="n">tries</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">trade_retcode_message</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Break-Even Order </span><span class="si">{</span><span class="n">msg</span><span class="si">}{</span><span class="n">addtionnal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Stop loss set to Break-even, Position: #</span><span class="si">{</span><span class="n">tiket</span><span class="si">}</span><span class="s2">, Symbol: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">, Price: @</span><span class="si">{</span><span class="n">price</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">break_even_status</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tiket</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.win_trade">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.win_trade">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">win_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">:</span> <span class="n">TradePosition</span><span class="p">,</span> <span class="n">th</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a positon is wining or looing</span>
<span class="sd">        wen it is closed before be level , tp or sl.</span>

<span class="sd">        Args:</span>
<span class="sd">            position (TradePosition): The trading position to check.</span>
<span class="sd">            th (int): The minimum profit for a position in point</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">trade_tick_size</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">trade_tick_value</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">profit</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">/</span> <span class="n">value</span> <span class="o">/</span> <span class="n">position</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span>

        <span class="n">point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_symbol_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">point</span>
        <span class="n">fees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stats</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;average_fee&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency_risk</span><span class="p">()[</span><span class="s2">&quot;trade_profit&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">min_be</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">fees</span> <span class="o">/</span> <span class="n">risk</span><span class="p">))</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
            <span class="n">min_be</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_info</span><span class="o">.</span><span class="n">spread</span>
        <span class="n">be</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_break_even</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">th</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">win_be</span> <span class="o">=</span> <span class="n">th</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">win_be</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">min_be</span><span class="p">,</span> <span class="nb">round</span><span class="p">((</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">be</span><span class="p">)))</span>
        <span class="n">win_trade</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">points</span> <span class="o">/</span> <span class="n">point</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">win_be</span>
        <span class="c1"># Check if the positon is in profit</span>
        <span class="k">if</span> <span class="n">win_trade</span><span class="p">:</span>
            <span class="c1"># Check if break-even has already been set for this position</span>
            <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">ticket</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">break_even_status</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Trade.profit_target">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.profit_target">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">profit_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fee</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">swap</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">commission</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">profit</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_account_info</span><span class="p">()</span><span class="o">.</span><span class="n">balance</span>
        <span class="n">target</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">balance</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">opened_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_today_deals</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opened_positions</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">opened_positions</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="c1"># This return two TradeDeal Object,</span>
                <span class="c1"># The first one is the opening order</span>
                <span class="c1"># The second is the closing order</span>
                <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trades_history</span><span class="p">(</span>
                    <span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="o">.</span><span class="n">position_id</span><span class="p">,</span> <span class="n">to_df</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">history</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">profit</span> <span class="o">+=</span> <span class="n">history</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">profit</span>
                    <span class="n">commission</span> <span class="o">+=</span> <span class="n">history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">commission</span>
                    <span class="n">swap</span> <span class="o">+=</span> <span class="n">history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">swap</span>
                    <span class="n">fee</span> <span class="o">+=</span> <span class="n">history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fee</span>
            <span class="n">current_profit</span> <span class="o">=</span> <span class="n">profit</span> <span class="o">+</span> <span class="n">commission</span> <span class="o">+</span> <span class="n">fee</span> <span class="o">+</span> <span class="n">swap</span>
            <span class="k">if</span> <span class="n">current_profit</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Trade.close_request">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.close_request">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">close_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close a trading order or position</span>

<span class="sd">        Args:</span>
<span class="sd">            request (dict): The request to close a trading order or position</span>
<span class="sd">            type (str): Type of the request (&#39;order&#39;, &#39;position&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ticket</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span>
        <span class="n">addtionnal</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;, SYMBOL=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_datetime</span><span class="p">()</span><span class="si">}</span><span class="s2"> -&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">trade_retcode_message</span><span class="p">(</span>
                <span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}{</span><span class="n">addtionnal</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">!=</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_INVALID_FILL</span><span class="p">:</span>  <span class="c1"># 10030</span>
                <span class="k">for</span> <span class="n">fill</span> <span class="ow">in</span> <span class="n">FILLING_TYPE</span><span class="p">:</span>
                    <span class="n">request</span><span class="p">[</span><span class="s2">&quot;type_filling&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">elif</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retcodes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_retcodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">trade_retcode_message</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">)</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Closing Order Request, </span><span class="si">{</span><span class="nb">type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">: #</span><span class="si">{</span><span class="n">ticket</span><span class="si">}</span><span class="s2">, RETCODE=</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">msg</span><span class="si">}{</span><span class="n">addtionnal</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">!=</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span> <span class="ow">and</span> <span class="n">tries</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">check_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_datetime</span><span class="p">()</span><span class="si">}</span><span class="s2"> -&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                        <span class="n">trade_retcode_message</span><span class="p">(</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}{</span><span class="n">addtionnal</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">tries</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">trade_retcode_message</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closing Order </span><span class="si">{</span><span class="n">msg</span><span class="si">}{</span><span class="n">addtionnal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> #</span><span class="si">{</span><span class="n">ticket</span><span class="si">}</span><span class="s2"> closed, Symbol: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">, Price: @</span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Trade.modify_order">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.modify_order">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">modify_order</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ticket</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stoplimit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Modify an open order by it ticket</span>

<span class="sd">        Args:</span>
<span class="sd">            ticket (int): Order ticket to modify (e.g TradeOrder.ticket)</span>
<span class="sd">            price (float): The price at which to modify the order</span>
<span class="sd">            stoplimit (float): A price a pending Limit order is set at</span>
<span class="sd">                when the price reaches the &#39;price&#39; value (this condition is mandatory).</span>
<span class="sd">                The pending order is not passed to the trading system until that moment</span>
<span class="sd">            sl (float): The stop loss in points</span>
<span class="sd">            tp (float): The take profit in points</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">orders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_orders</span><span class="p">(</span><span class="n">ticket</span><span class="o">=</span><span class="n">ticket</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Order #</span><span class="si">{</span><span class="n">ticket</span><span class="si">}</span><span class="s2"> not found, SYMBOL=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">, PRICE=</span><span class="si">{</span><span class="n">price</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">orders</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_ACTION_MODIFY</span><span class="p">,</span>
            <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="n">ticket</span><span class="p">,</span>
            <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">price</span> <span class="ow">or</span> <span class="n">order</span><span class="o">.</span><span class="n">price_open</span><span class="p">,</span>
            <span class="s2">&quot;sl&quot;</span><span class="p">:</span> <span class="n">sl</span> <span class="ow">or</span> <span class="n">order</span><span class="o">.</span><span class="n">sl</span><span class="p">,</span>
            <span class="s2">&quot;tp&quot;</span><span class="p">:</span> <span class="n">tp</span> <span class="ow">or</span> <span class="n">order</span><span class="o">.</span><span class="n">tp</span><span class="p">,</span>
            <span class="s2">&quot;stoplimit&quot;</span><span class="p">:</span> <span class="n">stoplimit</span> <span class="ow">or</span> <span class="n">order</span><span class="o">.</span><span class="n">price_stoplimit</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_order</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">retcode</span> <span class="o">==</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_RETCODE_DONE</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Order #</span><span class="si">{</span><span class="n">ticket</span><span class="si">}</span><span class="s2"> modified, SYMBOL=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">, PRICE=</span><span class="si">{</span><span class="n">price</span><span class="si">}</span><span class="s2">, SL=</span><span class="si">{</span><span class="n">sl</span><span class="si">}</span><span class="s2">, TP=</span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2">, STOP_LIMIT=</span><span class="si">{</span><span class="n">stoplimit</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">trade_retcode_message</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unable to modify Order #</span><span class="si">{</span><span class="n">ticket</span><span class="si">}</span><span class="s2">, RETCODE=</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">retcode</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">, SYMBOL=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Trade.close_order">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.close_order">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">close_order</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ticket</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">comment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close an open order by it ticket</span>

<span class="sd">        Args:</span>
<span class="sd">            ticket (int): Order ticket to close (e.g TradeOrder.ticket)</span>
<span class="sd">            id (int): The unique ID of the Expert or Strategy</span>
<span class="sd">            comment (str): Comment for the closing position</span>

<span class="sd">        Returns:</span>
<span class="sd">        -   True if order closed, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_ACTION_REMOVE</span><span class="p">,</span>
            <span class="s2">&quot;symbol&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
            <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="n">ticket</span><span class="p">,</span>
            <span class="s2">&quot;magic&quot;</span><span class="p">:</span> <span class="nb">id</span> <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">expert_id</span><span class="p">,</span>
            <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expert_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">comment</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">comment</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;order&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.close_position">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.close_position">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">close_position</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ticket</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pct</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">comment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">symbol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close an open position by it ticket</span>

<span class="sd">        Args:</span>
<span class="sd">            ticket (int): Positon ticket to close (e.g TradePosition.ticket)</span>
<span class="sd">            id (int): The unique ID of the Expert or Strategy</span>
<span class="sd">            pct (float): Percentage of the position to close</span>
<span class="sd">            comment (str): Comment for the closing position</span>

<span class="sd">        Returns:</span>
<span class="sd">        -   True if position closed, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get all Actives positions</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>
        <span class="n">Id</span> <span class="o">=</span> <span class="nb">id</span> <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">expert_id</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_positions</span><span class="p">(</span><span class="n">ticket</span><span class="o">=</span><span class="n">ticket</span><span class="p">)</span>
        <span class="n">buy_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tick_info</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">ask</span>
        <span class="n">sell_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tick_info</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">bid</span>
        <span class="n">deviation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_deviation</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">ticket</span> <span class="o">==</span> <span class="n">ticket</span> <span class="ow">and</span> <span class="n">position</span><span class="o">.</span><span class="n">magic</span> <span class="o">==</span> <span class="n">Id</span><span class="p">:</span>
                <span class="n">buy</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">TRADE_ACTION_DEAL</span><span class="p">,</span>
                    <span class="s2">&quot;symbol&quot;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                    <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">volume</span> <span class="o">*</span> <span class="n">pct</span><span class="p">),</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_SELL</span> <span class="k">if</span> <span class="n">buy</span> <span class="k">else</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TYPE_BUY</span><span class="p">,</span>
                    <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="n">ticket</span><span class="p">,</span>
                    <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">sell_price</span> <span class="k">if</span> <span class="n">buy</span> <span class="k">else</span> <span class="n">buy_price</span><span class="p">,</span>
                    <span class="s2">&quot;deviation&quot;</span><span class="p">:</span> <span class="n">deviation</span><span class="p">,</span>
                    <span class="s2">&quot;magic&quot;</span><span class="p">:</span> <span class="n">Id</span><span class="p">,</span>
                    <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expert_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">comment</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">comment</span><span class="p">,</span>
                    <span class="s2">&quot;type_time&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_TIME_GTC</span><span class="p">,</span>
                    <span class="s2">&quot;type_filling&quot;</span><span class="p">:</span> <span class="n">Mt5</span><span class="o">.</span><span class="n">ORDER_FILLING_FOK</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.bulk_close">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.bulk_close">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">bulk_close</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tickets</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
        <span class="n">tikets_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;positions&quot;</span><span class="p">,</span> <span class="s2">&quot;orders&quot;</span><span class="p">],</span>
        <span class="n">close_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">order_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">comment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close multiple orders or positions at once.</span>

<span class="sd">        Args:</span>
<span class="sd">            tickets (List): List of tickets to close</span>
<span class="sd">            tikets_type (str): Type of tickets to close (&#39;positions&#39;, &#39;orders&#39;)</span>
<span class="sd">            close_func (Callable): The function to close the tickets</span>
<span class="sd">            order_type (str): Type of orders or positions to close</span>
<span class="sd">            id (int): The unique ID of the Expert or Strategy</span>
<span class="sd">            comment (str): Comment for the closing position</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">order_type</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">order_type</span> <span class="o">=</span> <span class="s2">&quot;open&quot;</span>
        <span class="k">if</span> <span class="n">tickets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tickets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ticket</span> <span class="ow">in</span> <span class="n">tickets</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">close_func</span><span class="p">(</span><span class="n">ticket</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">):</span>
                    <span class="n">tickets</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ticket</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tickets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tickets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;ALL </span><span class="si">{</span><span class="n">order_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">tikets_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> closed, SYMBOL=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tickets</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">order_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">tikets_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> not closed, SYMBOL=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No </span><span class="si">{</span><span class="n">order_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">tikets_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> to close, SYMBOL=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Trade.close_orders">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.close_orders">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">close_orders</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">order_type</span><span class="p">:</span> <span class="n">Orders</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">comment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            order_type (str): Type of orders to close</span>
<span class="sd">                (&#39;all&#39;, &#39;buy_stops&#39;, &#39;sell_stops&#39;, &#39;buy_limits&#39;, &#39;sell_limits&#39;, &#39;buy_stop_limits&#39;, &#39;sell_stop_limits&#39;)</span>
<span class="sd">            id (int): The unique ID of the Expert or Strategy</span>
<span class="sd">            comment (str): Comment for the closing position</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="nb">id</span> <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">expert_id</span>
        <span class="k">if</span> <span class="n">order_type</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">orders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_orders</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">order_type</span> <span class="o">==</span> <span class="s2">&quot;buy_stops&quot;</span><span class="p">:</span>
            <span class="n">orders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_buy_stops</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">order_type</span> <span class="o">==</span> <span class="s2">&quot;sell_stops&quot;</span><span class="p">:</span>
            <span class="n">orders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_sell_stops</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">order_type</span> <span class="o">==</span> <span class="s2">&quot;buy_limits&quot;</span><span class="p">:</span>
            <span class="n">orders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_buy_limits</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">order_type</span> <span class="o">==</span> <span class="s2">&quot;sell_limits&quot;</span><span class="p">:</span>
            <span class="n">orders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_sell_limits</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">order_type</span> <span class="o">==</span> <span class="s2">&quot;buy_stop_limits&quot;</span><span class="p">:</span>
            <span class="n">orders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_buy_stop_limits</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">order_type</span> <span class="o">==</span> <span class="s2">&quot;sell_stop_limits&quot;</span><span class="p">:</span>
            <span class="n">orders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_sell_stop_limits</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid order type: </span><span class="si">{</span><span class="n">order_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bulk_close</span><span class="p">(</span>
            <span class="n">orders</span><span class="p">,</span> <span class="s2">&quot;orders&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_order</span><span class="p">,</span> <span class="n">order_type</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="n">comment</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Trade.close_positions">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.close_positions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">close_positions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">position_type</span><span class="p">:</span> <span class="n">Positions</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">comment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            position_type (str): Type of positions to close (&#39;all&#39;, &#39;buy&#39;, &#39;sell&#39;, &#39;profitable&#39;, &#39;losing&#39;)</span>
<span class="sd">            id (int): The unique ID of the Expert or Strategy</span>
<span class="sd">            comment (str): Comment for the closing position</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="nb">id</span> <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">expert_id</span>
        <span class="k">if</span> <span class="n">position_type</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_positions</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">position_type</span> <span class="o">==</span> <span class="s2">&quot;buy&quot;</span><span class="p">:</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_buys</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">position_type</span> <span class="o">==</span> <span class="s2">&quot;sell&quot;</span><span class="p">:</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_sells</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">position_type</span> <span class="o">==</span> <span class="s2">&quot;profitable&quot;</span><span class="p">:</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_profitables</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">position_type</span> <span class="o">==</span> <span class="s2">&quot;losing&quot;</span><span class="p">:</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_losings</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid position type: </span><span class="si">{</span><span class="n">position_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bulk_close</span><span class="p">(</span>
            <span class="n">positions</span><span class="p">,</span>
            <span class="s2">&quot;positions&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_position</span><span class="p">,</span>
            <span class="n">position_type</span><span class="p">,</span>
            <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Trade.get_today_deals">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.get_today_deals">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_today_deals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">TradeDeal</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all today deals for a specific symbol or group of symbols</span>

<span class="sd">        Args:</span>
<span class="sd">            group (str): Symbol or group or symbol</span>
<span class="sd">        Returns:</span>
<span class="sd">            List[TradeDeal]: List of today deals</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">date_from</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">history</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_trades_history</span><span class="p">(</span><span class="n">date_from</span><span class="o">=</span><span class="n">date_from</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">to_df</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="p">)</span>
        <span class="n">positions_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="p">[</span><span class="n">deal</span><span class="o">.</span><span class="n">position_id</span> <span class="k">for</span> <span class="n">deal</span> <span class="ow">in</span> <span class="n">history</span> <span class="k">if</span> <span class="n">deal</span><span class="o">.</span><span class="n">magic</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">expert_id</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">today_deals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">positions_ids</span><span class="p">:</span>
            <span class="n">deal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trades_history</span><span class="p">(</span>
                <span class="n">date_from</span><span class="o">=</span><span class="n">date_from</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="p">,</span> <span class="n">to_df</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">deal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">deal</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">deal_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">deal</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">deal_time</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">==</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">():</span>
                    <span class="n">today_deals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deal</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">today_deals</span></div>


<div class="viewcode-block" id="Trade.is_max_trades_reached">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.is_max_trades_reached">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_max_trades_reached</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the maximum number of trades for the day has been reached.</span>

<span class="sd">        :return: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">negative_deals</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">max_trades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_trade</span><span class="p">()</span>
        <span class="n">today_deals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_today_deals</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">deal</span> <span class="ow">in</span> <span class="n">today_deals</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">deal</span><span class="o">.</span><span class="n">profit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">negative_deals</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">negative_deals</span> <span class="o">&gt;=</span> <span class="n">max_trades</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Trade.get_stats">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.get_stats">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get some stats about the trading day and trading history</span>

<span class="sd">        :return: tuple[Dict[str, Any]]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get history of deals for one trading session</span>
        <span class="n">profit</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">total_fees</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">loss_trades</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">win_trades</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_account_info</span><span class="p">()</span><span class="o">.</span><span class="n">balance</span>
        <span class="n">today_deals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_today_deals</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">deals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">today_deals</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">deals</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">today_deals</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trades_history</span><span class="p">(</span>
                    <span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="o">.</span><span class="n">position_id</span><span class="p">,</span> <span class="n">to_df</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">history</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">profit</span>
                    <span class="n">comm</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">commission</span>
                    <span class="n">swap</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">swap</span>
                    <span class="n">fee</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fee</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">+</span> <span class="n">comm</span> <span class="o">+</span> <span class="n">swap</span> <span class="o">+</span> <span class="n">fee</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">loss_trades</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">win_trades</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">profit</span> <span class="o">+=</span> <span class="n">result</span>
                    <span class="n">total_fees</span> <span class="o">+=</span> <span class="n">comm</span> <span class="o">+</span> <span class="n">swap</span> <span class="o">+</span> <span class="n">fee</span>
            <span class="n">average_fee</span> <span class="o">=</span> <span class="n">total_fees</span> <span class="o">/</span> <span class="n">deals</span>
            <span class="n">win_rate</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">win_trades</span> <span class="o">/</span> <span class="n">deals</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">stats1</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;deals&quot;</span><span class="p">:</span> <span class="n">deals</span><span class="p">,</span>
                <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="n">profit</span><span class="p">,</span>
                <span class="s2">&quot;win_trades&quot;</span><span class="p">:</span> <span class="n">win_trades</span><span class="p">,</span>
                <span class="s2">&quot;loss_trades&quot;</span><span class="p">:</span> <span class="n">loss_trades</span><span class="p">,</span>
                <span class="s2">&quot;total_fees&quot;</span><span class="p">:</span> <span class="n">total_fees</span><span class="p">,</span>
                <span class="s2">&quot;average_fee&quot;</span><span class="p">:</span> <span class="n">average_fee</span><span class="p">,</span>
                <span class="s2">&quot;win_rate&quot;</span><span class="p">:</span> <span class="n">win_rate</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stats1</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;deals&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;win_trades&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;loss_trades&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;total_fees&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;average_fee&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;win_rate&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="c1"># Get total stats</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trades_history</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">profit</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;profit&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">commisions</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;commission&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">_fees</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;fee&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">_swap</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;swap&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">total_profit</span> <span class="o">=</span> <span class="n">commisions</span> <span class="o">+</span> <span class="n">_fees</span> <span class="o">+</span> <span class="n">_swap</span> <span class="o">+</span> <span class="n">profit</span>
            <span class="n">balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_account_info</span><span class="p">()</span><span class="o">.</span><span class="n">balance</span>
            <span class="n">initial_balance</span> <span class="o">=</span> <span class="n">balance</span> <span class="o">-</span> <span class="n">total_profit</span>
            <span class="n">profittable</span> <span class="o">=</span> <span class="s2">&quot;Yes&quot;</span> <span class="k">if</span> <span class="n">balance</span> <span class="o">&gt;</span> <span class="n">initial_balance</span> <span class="k">else</span> <span class="s2">&quot;No&quot;</span>
            <span class="n">stats2</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;total_profit&quot;</span><span class="p">:</span> <span class="n">total_profit</span><span class="p">,</span> <span class="s2">&quot;profitability&quot;</span><span class="p">:</span> <span class="n">profittable</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stats2</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;total_profit&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;profitability&quot;</span><span class="p">:</span> <span class="s2">&quot;No&quot;</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">stats1</span><span class="p">,</span> <span class="n">stats2</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.sharpe">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.sharpe">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sharpe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the Sharpe ratio of a returns stream</span>
<span class="sd">        based on a number of trading periods.</span>
<span class="sd">        The function assumes that the returns are the excess of</span>
<span class="sd">        those compared to a benchmark.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trades_history</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">df2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">profit</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;profit&quot;</span><span class="p">,</span> <span class="s2">&quot;commission&quot;</span><span class="p">,</span> <span class="s2">&quot;fee&quot;</span><span class="p">,</span> <span class="s2">&quot;swap&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">profit</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">fill_method</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">periods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_trade</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
        <span class="n">sharpe</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sharpe</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">periods</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">sharpe</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.days_end">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.days_end">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">days_end</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if it is the end of the trading day.&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="s2">&quot;%H:%M&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">now</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Trade.trading_time">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.trading_time">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">trading_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if it is time to trade.&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="s2">&quot;%H:%M&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finishing</span><span class="p">,</span> <span class="s2">&quot;%H:%M&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="n">now</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Trade.sleep_time">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.sleep_time">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sleep_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weekend</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">weekend</span><span class="p">:</span>
            <span class="c1"># claculate number of minute from the friday and to monday start</span>
            <span class="n">friday_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_time</span><span class="p">(),</span> <span class="s2">&quot;%H:%M&quot;</span><span class="p">)</span>
            <span class="n">monday_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="s2">&quot;%H:%M&quot;</span><span class="p">)</span>
            <span class="n">intra_day_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">monday_time</span> <span class="o">-</span> <span class="n">friday_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">//</span> <span class="mi">60</span>
            <span class="n">inter_day_diff</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span>
            <span class="n">total_minutes</span> <span class="o">=</span> <span class="n">inter_day_diff</span> <span class="o">+</span> <span class="n">intra_day_diff</span>
            <span class="k">return</span> <span class="n">total_minutes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># claculate number of minute from the end to the start</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="s2">&quot;%H:%M&quot;</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_time</span><span class="p">(),</span> <span class="s2">&quot;%H:%M&quot;</span><span class="p">)</span>
            <span class="n">minutes</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">//</span> <span class="mi">60</span>
            <span class="n">sleep_time</span> <span class="o">=</span> <span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-</span> <span class="n">minutes</span>
            <span class="k">return</span> <span class="n">sleep_time</span></div>


<div class="viewcode-block" id="Trade.current_datetime">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.current_datetime">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">current_datetime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trade.current_time">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.Trade.current_time">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">current_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seconds</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">seconds</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H:%M&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="create_trade_instance">
<a class="viewcode-back" href="../../../bbstrader.metatrader.html#bbstrader.metatrader.trade.create_trade_instance">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_trade_instance</span><span class="p">(</span>
    <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">daily_risk</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_risk</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pchange_sl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Trade</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates Trade instances for each symbol provided.</span>

<span class="sd">    Args:</span>
<span class="sd">        symbols: A list of trading symbols (e.g., [&#39;AAPL&#39;, &#39;MSFT&#39;]).</span>
<span class="sd">        params: A dictionary containing parameters for the Trade instance.</span>
<span class="sd">        daily_risk: A dictionary containing daily risk weight for each symbol.</span>
<span class="sd">        max_risk: A dictionary containing maximum risk weight for each symbol.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary where keys are symbols and values are corresponding Trade instances.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the &#39;symbols&#39; list is empty or the &#39;params&#39; dictionary is missing required keys.</span>

<span class="sd">    Note:</span>
<span class="sd">        `daily_risk` and `max_risk`  can be used to manage the risk of each symbol</span>
<span class="sd">        based on the importance of the symbol in the portfolio or strategy.</span>
<span class="sd">        See bbstrader.metatrader.trade.Trade for more details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;logger&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">Logger</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">log</span><span class="p">))):</span>
        <span class="n">loggr</span> <span class="o">=</span> <span class="n">log</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">loggr</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;logger&quot;</span><span class="p">)</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;expert_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">trade_instances</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">symbols</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The &#39;symbols&#39; list cannot be empty.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The &#39;params&#39; dictionary cannot be empty.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">daily_risk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">daily_risk</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing daily risk weight for symbol &#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">max_risk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">max_risk</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Missing maximum risk percentage for symbol &#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">)</span>
    <span class="k">if</span> <span class="n">pchange_sl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pchange_sl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pchange_sl</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Missing percentage change for symbol &#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                    <span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing expert ID for symbol &#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;symbol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">symbol</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;expert_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ids</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">ids</span>
                <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
                <span class="k">else</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;expert_id&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;expert_id&quot;</span> <span class="ow">in</span> <span class="n">params</span>
                <span class="k">else</span> <span class="n">EXPERT_ID</span>
            <span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;pchange_sl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">pchange_sl</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">pchange_sl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pchange_sl</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">pchange_sl</span>
                <span class="k">if</span> <span class="n">pchange_sl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pchange_sl</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
                <span class="k">else</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;pchange_sl&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;pchange_sl&quot;</span> <span class="ow">in</span> <span class="n">params</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;daily_risk&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">daily_risk</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">daily_risk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;daily_risk&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;daily_risk&quot;</span> <span class="ow">in</span> <span class="n">params</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;max_risk&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">max_risk</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">max_risk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;max_risk&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;max_risk&quot;</span> <span class="ow">in</span> <span class="n">params</span>
                <span class="k">else</span> <span class="mf">10.0</span>
            <span class="p">)</span>
            <span class="n">trade_instances</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">loggr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating Trade instance, SYMBOL=</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trade_instances</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trade_instances</span><span class="p">:</span>
                <span class="n">loggr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create Trade instance for SYMBOL=</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">loggr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Trade instances created successfully for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">trade_instances</span><span class="p">)</span><span class="si">}</span><span class="s2"> symbols.&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">trade_instances</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023 - 2025, Bertin Balouki SIMYELI.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>